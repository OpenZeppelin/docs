---
title: "General"
description: "Smart contract general utilities and implementations"
---

<a id="AntiSandwichHook"></a>

<div style={{marginTop: "4em"}} className="w-full flex flex-row items-center justify-between">

## `AntiSandwichHook`

<a target="_blank" style={{marginTop: "1.5em"}} href="https://github.com/OpenZeppelin/uniswap-hooks/blob/v1.1.0/src/general/AntiSandwichHook.sol">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
</a>

</div>

```solidity
import "uniswap-hooks/src/general/AntiSandwichHook.sol";
```

This hook implements the sandwich-resistant AMM design introduced
[here](https://www.umbraresearch.xyz/writings/sandwich-resistant-amm). Specifically,
this hook guarantees that no swaps get filled at a price better than the price at
the beginning of the slot window (i.e. one block).

Within a slot window, swaps impact the pool asymmetrically for buys and sells.
When a buy order is executed, the offer on the pool increases in accordance with
the xy=k curve. However, the bid price remains constant, instead increasing the
amount of liquidity on the bid. Subsequent sells eat into this liquidity, while
decreasing the offer price according to xy=k.

In order to use this hook, the inheriting contract must implement the `_handleCollectedFees` function
to determine how to handle the collected fees from the anti-sandwich mechanism.

<Callout>
The Anti-sandwich mechanism only protects swaps in the zeroForOne swap direction.
Swaps in the !zeroForOne direction are not protected by this hook design.
</Callout>

<Callout type="warn">
Since this hook makes MEV not profitable, there's not as much arbitrage in
the pool, making prices at beginning of the block not necessarily close to market price.
</Callout>

<Callout type="warn">
In `_beforeSwap`, the hook iterates over all ticks between last tick and current tick.
Developers must be aware that for large price changes in pools with small tick spacing, the `for`
loop will iterate over a large number of ticks, which could lead to `MemoryOOG` error.
</Callout>

<Callout type="warn">
This is experimental software and is provided on an "as is" and "as available" basis. We do
not give any warranties and will not be liable for any losses incurred through any use of this code
base.
</Callout>

_Available since v1.1.0_

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Functions</h3>
<div className="font-mono">
- [constructor(_poolManager)](#AntiSandwichHook-constructor-contract-IPoolManager-)
- [_beforeSwap(sender, key, params, hookData)](#AntiSandwichHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [_getBlockNumber()](#AntiSandwichHook-_getBlockNumber--)
- [_getTargetUnspecified(, key, params, )](#AntiSandwichHook-_getTargetUnspecified-address-struct-PoolKey-struct-SwapParams-bytes-)
- [getHookPermissions()](#AntiSandwichHook-getHookPermissions--)
#### BaseDynamicAfterFee [!toc]
- [_transientTargetUnspecifiedAmount()](#BaseDynamicAfterFee-_transientTargetUnspecifiedAmount--)
- [_transientApplyTarget()](#BaseDynamicAfterFee-_transientApplyTarget--)
- [_setTransientTargetUnspecifiedAmount(value)](#BaseDynamicAfterFee-_setTransientTargetUnspecifiedAmount-uint256-)
- [_setTransientApplyTarget(value)](#BaseDynamicAfterFee-_setTransientApplyTarget-bool-)
- [_afterSwap(sender, key, params, delta, )](#BaseDynamicAfterFee-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [_afterSwapHandler(key, params, delta, targetUnspecifiedAmount, feeAmount)](#BaseDynamicAfterFee-_afterSwapHandler-struct-PoolKey-struct-SwapParams-BalanceDelta-uint256-uint256-)
#### IHookEvents [!toc]
#### BaseHook [!toc]
- [_validateHookAddress(hook)](#BaseHook-_validateHookAddress-contract-BaseHook-)
- [beforeInitialize(sender, key, sqrtPriceX96)](#BaseHook-beforeInitialize-address-struct-PoolKey-uint160-)
- [_beforeInitialize(, , )](#BaseHook-_beforeInitialize-address-struct-PoolKey-uint160-)
- [afterInitialize(sender, key, sqrtPriceX96, tick)](#BaseHook-afterInitialize-address-struct-PoolKey-uint160-int24-)
- [_afterInitialize(, , , )](#BaseHook-_afterInitialize-address-struct-PoolKey-uint160-int24-)
- [beforeAddLiquidity(sender, key, params, hookData)](#BaseHook-beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeAddLiquidity(, , , )](#BaseHook-_beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [beforeRemoveLiquidity(sender, key, params, hookData)](#BaseHook-beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeRemoveLiquidity(, , , )](#BaseHook-_beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [afterAddLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterAddLiquidity(, , , , , )](#BaseHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [afterRemoveLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterRemoveLiquidity(, , , , , )](#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [beforeSwap(sender, key, params, hookData)](#BaseHook-beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [afterSwap(sender, key, params, delta, hookData)](#BaseHook-afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [beforeDonate(sender, key, amount0, amount1, hookData)](#BaseHook-beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_beforeDonate(, , , , )](#BaseHook-_beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [afterDonate(sender, key, amount0, amount1, hookData)](#BaseHook-afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_afterDonate(, , , , )](#BaseHook-_afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [poolManager()](#BaseHook-poolManager-contract-IPoolManager)
#### IHooks [!toc]
</div>
</div>

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Events</h3>
<div className="font-mono">
#### BaseDynamicAfterFee [!toc]
#### IHookEvents [!toc]
- [HookSwap(poolId, sender, amount0, amount1, hookLPfeeAmount0, hookLPfeeAmount1)](#IHookEvents-HookSwap-bytes32-address-int128-int128-uint128-uint128-)
- [HookFee(poolId, sender, feeAmount0, feeAmount1)](#IHookEvents-HookFee-bytes32-address-uint128-uint128-)
- [HookModifyLiquidity(poolId, sender, amount0, amount1)](#IHookEvents-HookModifyLiquidity-bytes32-address-int128-int128-)
- [HookBonus(poolId, amount0, amount1)](#IHookEvents-HookBonus-bytes32-uint128-uint128-)
#### BaseHook [!toc]
#### IHooks [!toc]
</div>
</div>

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Errors</h3>
<div className="font-mono">
#### BaseDynamicAfterFee [!toc]
#### IHookEvents [!toc]
#### BaseHook [!toc]
- [NotSelf()](#BaseHook-NotSelf--)
- [InvalidPool()](#BaseHook-InvalidPool--)
- [HookNotImplemented()](#BaseHook-HookNotImplemented--)
- [NotPoolManager()](#BaseHook-NotPoolManager--)
#### IHooks [!toc]
</div>
</div>

<a id="AntiSandwichHook-constructor-contract-IPoolManager-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">constructor(contract IPoolManager _poolManager)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="AntiSandwichHook-constructor-contract-IPoolManager-">#</a>
</div>
</div>
<div className="px-4">

</div>
</div>

<a id="AntiSandwichHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_beforeSwap(address sender, struct PoolKey key, struct SwapParams params, bytes hookData) → bytes4, BeforeSwapDelta, uint24</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="AntiSandwichHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-">#</a>
</div>
</div>
<div className="px-4">

Handles the before swap hook.

For the first swap in a block, it saves the current pool state as a checkpoint.

For subsequent swaps in the same block, it calculates a target output based on the beginning-of-block state,
and sets the inherited `_targetOutput` and `_applyTargetOutput` variables to enforce price limits in [`BaseHook._afterSwap`](base#BaseHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-).

</div>
</div>

<a id="AntiSandwichHook-_getBlockNumber--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_getBlockNumber() → uint48</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="AntiSandwichHook-_getBlockNumber--">#</a>
</div>
</div>
<div className="px-4">

Returns the current block number.

</div>
</div>

<a id="AntiSandwichHook-_getTargetUnspecified-address-struct-PoolKey-struct-SwapParams-bytes-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_getTargetUnspecified(address, struct PoolKey key, struct SwapParams params, bytes) → uint256 targetUnspecifiedAmount, bool applyTarget</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="AntiSandwichHook-_getTargetUnspecified-address-struct-PoolKey-struct-SwapParams-bytes-">#</a>
</div>
</div>
<div className="px-4">

Calculates the unspecified amount based on the pool state at the beginning of the block.
This prevents sandwich attacks by ensuring trades can't get better prices than what was available
at the start of the block. Note that the calculated unspecified amount could either be input or output, depending
if it's an exactInput or outputOutput swap. In cases of zeroForOne == true, the target unspecified amount is not
applicable, and the max uint256 value is returned as a flag only.

The anti-sandwich mechanism works such as:

- For currency0 to currency1 swaps (zeroForOne = true): The pool behaves normally with xy=k curve.
- For currency1 to currency0 swaps (zeroForOne = false): The price is fixed at the beginning-of-block
  price, which prevents attackers from manipulating the price within a block.

</div>
</div>

<a id="AntiSandwichHook-getHookPermissions--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getHookPermissions() → struct Hooks.Permissions permissions</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="AntiSandwichHook-getHookPermissions--">#</a>
</div>
</div>
<div className="px-4">

Set the hook permissions, specifically `beforeSwap`, `afterSwap`, and `afterSwapReturnDelta`.

</div>
</div>

<a id="OrderIdLibrary"></a>

<div style={{marginTop: "4em"}} className="w-full flex flex-row items-center justify-between">

## `OrderIdLibrary`

<a target="_blank" style={{marginTop: "1.5em"}} href="https://github.com/OpenZeppelin/uniswap-hooks/blob/v1.1.0/src/general/LimitOrderHook.sol">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
</a>

</div>

```solidity
import "uniswap-hooks/src/general/LimitOrderHook.sol";
```

The order id library.

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Functions</h3>
<div className="font-mono">
- [equals(a, b)](#OrderIdLibrary-equals-OrderIdLibrary-OrderId-OrderIdLibrary-OrderId-)
- [unsafeIncrement(a)](#OrderIdLibrary-unsafeIncrement-OrderIdLibrary-OrderId-)
</div>
</div>

<a id="OrderIdLibrary-equals-OrderIdLibrary-OrderId-OrderIdLibrary-OrderId-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">equals(OrderIdLibrary.OrderId a, OrderIdLibrary.OrderId b) → bool</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="OrderIdLibrary-equals-OrderIdLibrary-OrderId-OrderIdLibrary-OrderId-">#</a>
</div>
</div>
<div className="px-4">

Compare two order ids for equality. Takes two `OrderId` values `a` and `b` and
returns whether their underlying values are equal.

</div>
</div>

<a id="OrderIdLibrary-unsafeIncrement-OrderIdLibrary-OrderId-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">unsafeIncrement(OrderIdLibrary.OrderId a) → OrderIdLibrary.OrderId</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="OrderIdLibrary-unsafeIncrement-OrderIdLibrary-OrderId-">#</a>
</div>
</div>
<div className="px-4">

Increment the order id `a`. Might overflow.

</div>
</div>

<a id="LimitOrderHook"></a>

<div style={{marginTop: "4em"}} className="w-full flex flex-row items-center justify-between">

## `LimitOrderHook`

<a target="_blank" style={{marginTop: "1.5em"}} href="https://github.com/OpenZeppelin/uniswap-hooks/blob/v1.1.0/src/general/LimitOrderHook.sol">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
</a>

</div>

```solidity
import "uniswap-hooks/src/general/LimitOrderHook.sol";
```

Limit Order Mechanism hook.

Allows users to place limit orders at specific ticks outside of the current price range,
which will be filled if the pool's price crosses the order's tick.

Note that given the way UniswapV4 pools works, when liquidity is added out of the current range,
a single currency will be provided, instead of both currencies as in in-range liquidity additions.

Orders can be cancelled at any time until they are filled and their liquidity is removed from the pool.
Once completely filled, the resulting liquidity can be withdrawn from the pool.

<Callout type="warn">
When cancelling or adding more liquidity into an existing order, it's possible that fees
have been accrued. In those cases, the accrued fees are added to the order info, benefitting the remaining
limit order placers.
</Callout>

<Callout type="warn">
This is experimental software and is provided on an "as is" and "as available" basis. We do
not give any warranties and will not be liable for any losses incurred through any use of this code
base.
</Callout>

_Available since v1.1.0_

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Functions</h3>
<div className="font-mono">
- [constructor(_poolManager)](#LimitOrderHook-constructor-contract-IPoolManager-)
- [_afterInitialize(, key, , tick)](#LimitOrderHook-_afterInitialize-address-struct-PoolKey-uint160-int24-)
- [_afterSwap(, key, params, , )](#LimitOrderHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [placeOrder(key, tick, zeroForOne, liquidity)](#LimitOrderHook-placeOrder-struct-PoolKey-int24-bool-uint128-)
- [cancelOrder(key, tickLower, zeroForOne, to)](#LimitOrderHook-cancelOrder-struct-PoolKey-int24-bool-address-)
- [withdraw(orderId, to)](#LimitOrderHook-withdraw-OrderIdLibrary-OrderId-address-)
- [unlockCallback(rawData)](#LimitOrderHook-unlockCallback-bytes-)
- [_handlePlaceCallback(placeData)](#LimitOrderHook-_handlePlaceCallback-struct-LimitOrderHook-PlaceCallbackData-)
- [_handleCancelCallback(cancelData)](#LimitOrderHook-_handleCancelCallback-struct-LimitOrderHook-CancelCallbackData-)
- [_handleWithdrawCallback(withdrawData)](#LimitOrderHook-_handleWithdrawCallback-struct-LimitOrderHook-WithdrawCallbackData-)
- [_fillOrder(key, tickLower, zeroForOne)](#LimitOrderHook-_fillOrder-struct-PoolKey-int24-bool-)
- [_getCrossedTicks(poolId, tickSpacing)](#LimitOrderHook-_getCrossedTicks-PoolId-int24-)
- [getTickLowerLast(poolId)](#LimitOrderHook-getTickLowerLast-PoolId-)
- [getOrderId(key, tickLower, zeroForOne)](#LimitOrderHook-getOrderId-struct-PoolKey-int24-bool-)
- [_getTickLower(tick, tickSpacing)](#LimitOrderHook-_getTickLower-int24-int24-)
- [getOrderLiquidity(orderId, owner)](#LimitOrderHook-getOrderLiquidity-OrderIdLibrary-OrderId-address-)
- [_getTick(poolId)](#LimitOrderHook-_getTick-PoolId-)
- [getOrderInfo(orderId)](#LimitOrderHook-getOrderInfo-OrderIdLibrary-OrderId-)
- [getHookPermissions()](#LimitOrderHook-getHookPermissions--)
#### IUnlockCallback [!toc]
#### BaseHook [!toc]
- [_validateHookAddress(hook)](#BaseHook-_validateHookAddress-contract-BaseHook-)
- [beforeInitialize(sender, key, sqrtPriceX96)](#BaseHook-beforeInitialize-address-struct-PoolKey-uint160-)
- [_beforeInitialize(, , )](#BaseHook-_beforeInitialize-address-struct-PoolKey-uint160-)
- [afterInitialize(sender, key, sqrtPriceX96, tick)](#BaseHook-afterInitialize-address-struct-PoolKey-uint160-int24-)
- [beforeAddLiquidity(sender, key, params, hookData)](#BaseHook-beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeAddLiquidity(, , , )](#BaseHook-_beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [beforeRemoveLiquidity(sender, key, params, hookData)](#BaseHook-beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeRemoveLiquidity(, , , )](#BaseHook-_beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [afterAddLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterAddLiquidity(, , , , , )](#BaseHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [afterRemoveLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterRemoveLiquidity(, , , , , )](#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [beforeSwap(sender, key, params, hookData)](#BaseHook-beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [_beforeSwap(, , , )](#BaseHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [afterSwap(sender, key, params, delta, hookData)](#BaseHook-afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [beforeDonate(sender, key, amount0, amount1, hookData)](#BaseHook-beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_beforeDonate(, , , , )](#BaseHook-_beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [afterDonate(sender, key, amount0, amount1, hookData)](#BaseHook-afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_afterDonate(, , , , )](#BaseHook-_afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [poolManager()](#BaseHook-poolManager-contract-IPoolManager)
#### IHooks [!toc]
</div>
</div>

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Events</h3>
<div className="font-mono">
- [Place(owner, orderId, key, tickLower, zeroForOne, liquidity)](#LimitOrderHook-Place-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-)
- [Fill(orderId, key, tickLower, zeroForOne)](#LimitOrderHook-Fill-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-)
- [Cancel(owner, orderId, key, tickLower, zeroForOne, liquidity)](#LimitOrderHook-Cancel-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-)
- [Withdraw(owner, orderId, liquidity)](#LimitOrderHook-Withdraw-address-OrderIdLibrary-OrderId-uint128-)
#### IUnlockCallback [!toc]
#### BaseHook [!toc]
#### IHooks [!toc]
</div>
</div>

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Errors</h3>
<div className="font-mono">
- [ZeroLiquidity()](#LimitOrderHook-ZeroLiquidity--)
- [InRange()](#LimitOrderHook-InRange--)
- [CrossedRange()](#LimitOrderHook-CrossedRange--)
- [Filled()](#LimitOrderHook-Filled--)
- [NotFilled()](#LimitOrderHook-NotFilled--)
#### IUnlockCallback [!toc]
#### BaseHook [!toc]
- [NotSelf()](#BaseHook-NotSelf--)
- [InvalidPool()](#BaseHook-InvalidPool--)
- [HookNotImplemented()](#BaseHook-HookNotImplemented--)
- [NotPoolManager()](#BaseHook-NotPoolManager--)
#### IHooks [!toc]
</div>
</div>

<a id="LimitOrderHook-constructor-contract-IPoolManager-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">constructor(contract IPoolManager _poolManager)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-constructor-contract-IPoolManager-">#</a>
</div>
</div>
<div className="px-4">

Set the `PoolManager` address.

</div>
</div>

<a id="LimitOrderHook-_afterInitialize-address-struct-PoolKey-uint160-int24-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_afterInitialize(address, struct PoolKey key, uint160, int24 tick) → bytes4</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_afterInitialize-address-struct-PoolKey-uint160-int24-">#</a>
</div>
</div>
<div className="px-4">

Hooks into the `afterInitialize` hook to set the last tick lower for the pool.

</div>
</div>

<a id="LimitOrderHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_afterSwap(address, struct PoolKey key, struct SwapParams params, BalanceDelta, bytes) → bytes4, int128</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-">#</a>
</div>
</div>
<div className="px-4">

Hooks into the `afterSwap` hook to get the ticks crossed by the swap and fill the orders that are crossed, filling them.

</div>
</div>

<a id="LimitOrderHook-placeOrder-struct-PoolKey-int24-bool-uint128-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">placeOrder(struct PoolKey key, int24 tick, bool zeroForOne, uint128 liquidity)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-placeOrder-struct-PoolKey-int24-bool-uint128-">#</a>
</div>
</div>
<div className="px-4">

Places a limit order by adding liquidity out of range at a specific tick. The order will be filled when the
pool price crosses the specified `tick`. Takes a `PoolKey` `key`, target `tick`, direction `zeroForOne` indicating
whether to buy currency0 or currency1, and amount of `liquidity` to place. The interaction with the `poolManager` is done
via the `unlock` function, which will trigger the `[`BaseCustomAccounting.unlockCallback`](base#BaseCustomAccounting-unlockCallback-bytes-)` function.

</div>
</div>

<a id="LimitOrderHook-cancelOrder-struct-PoolKey-int24-bool-address-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">cancelOrder(struct PoolKey key, int24 tickLower, bool zeroForOne, address to)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-cancelOrder-struct-PoolKey-int24-bool-address-">#</a>
</div>
</div>
<div className="px-4">

Cancels a limit order by removing liquidity from the pool. Takes a `PoolKey` `key`, `tickLower` of the order,
direction `zeroForOne` indicating whether it was buying currency0 or currency1, and recipient address `to` for the
removed liquidity. Note that partial cancellation is not supported - the entire liquidity added by the msg.sender will be removed.
Note also that cancelling an order will cancel the order placed by the msg.sender, not orders placed by other users in the same tick range.
The interaction with the `poolManager` is done via the `unlock` function, which will trigger the `[`BaseCustomAccounting.unlockCallback`](base#BaseCustomAccounting-unlockCallback-bytes-)` function.

</div>
</div>

<a id="LimitOrderHook-withdraw-OrderIdLibrary-OrderId-address-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">withdraw(OrderIdLibrary.OrderId orderId, address to) → uint256 amount0, uint256 amount1</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-withdraw-OrderIdLibrary-OrderId-address-">#</a>
</div>
</div>
<div className="px-4">

Withdraws liquidity from a filled order, sending it to address `to`. Takes an `OrderId` `orderId` of the filled
order to withdraw from. Returns the withdrawn amounts as `(amount0, amount1)`. Can only be called after the order is
filled - use `cancelOrder` to remove liquidity from unfilled orders. The interaction with the `poolManager` is done via the
`unlock` function, which will trigger the `[`BaseCustomAccounting.unlockCallback`](base#BaseCustomAccounting-unlockCallback-bytes-)` function.

</div>
</div>

<a id="LimitOrderHook-unlockCallback-bytes-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">unlockCallback(bytes rawData) → bytes returnData</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-unlockCallback-bytes-">#</a>
</div>
</div>
<div className="px-4">

Handles callbacks from the `PoolManager` for order operations. Takes encoded `rawData` containing the callback type
and operation-specific data. Returns encoded data containing fees accrued for cancel operations, or empty bytes
otherwise. Only callable by the PoolManager.

</div>
</div>

<a id="LimitOrderHook-_handlePlaceCallback-struct-LimitOrderHook-PlaceCallbackData-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_handlePlaceCallback(struct LimitOrderHook.PlaceCallbackData placeData) → uint256 amount0Fee, uint256 amount1Fee</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_handlePlaceCallback-struct-LimitOrderHook-PlaceCallbackData-">#</a>
</div>
</div>
<div className="px-4">

Internal handler for place order callbacks. Takes `placeData` containing the order details and adds the
specified liquidity to the pool out of range. Reverts if the order would be placed in range or on the wrong
side of the range.

</div>
</div>

<a id="LimitOrderHook-_handleCancelCallback-struct-LimitOrderHook-CancelCallbackData-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_handleCancelCallback(struct LimitOrderHook.CancelCallbackData cancelData) → uint256 amount0Fee, uint256 amount1Fee</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_handleCancelCallback-struct-LimitOrderHook-CancelCallbackData-">#</a>
</div>
</div>
<div className="px-4">

Internal handler for cancel order callbacks. Takes `cancelData` containing the cancellation details and
removes liquidity from the pool. Returns accrued fees `(amount0Fee, amount1Fee)` which are allocated to remaining
limit order placers, or to the cancelling user if they're removing all liquidity.

</div>
</div>

<a id="LimitOrderHook-_handleWithdrawCallback-struct-LimitOrderHook-WithdrawCallbackData-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_handleWithdrawCallback(struct LimitOrderHook.WithdrawCallbackData withdrawData)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_handleWithdrawCallback-struct-LimitOrderHook-WithdrawCallbackData-">#</a>
</div>
</div>
<div className="px-4">

Internal handler for withdraw callbacks. Takes `withdrawData` containing withdrawal amounts and recipient,
burns the specified currency amounts from the hook, and transfers them to the recipient address.

</div>
</div>

<a id="LimitOrderHook-_fillOrder-struct-PoolKey-int24-bool-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_fillOrder(struct PoolKey key, int24 tickLower, bool zeroForOne)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_fillOrder-struct-PoolKey-int24-bool-">#</a>
</div>
</div>
<div className="px-4">

Internal handler for filling limit orders when price crosses a tick. Takes a `PoolKey` `key`, target `tickLower`,
and direction `zeroForOne`. Removes liquidity from filled orders, mints the received currencies to the hook, and
updates order state to track filled amounts.

</div>
</div>

<a id="LimitOrderHook-_getCrossedTicks-PoolId-int24-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_getCrossedTicks(PoolId poolId, int24 tickSpacing) → int24 tickLower, int24 lower, int24 upper</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_getCrossedTicks-PoolId-int24-">#</a>
</div>
</div>
<div className="px-4">

Internal helper that calculates the range of ticks crossed during a price change. Takes a `PoolId` `poolId`
and `tickSpacing`, returns the current `tickLower` and the range of ticks crossed (`lower`, `upper`) that need
to be checked for limit orders.

</div>
</div>

<a id="LimitOrderHook-getTickLowerLast-PoolId-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getTickLowerLast(PoolId poolId) → int24</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-getTickLowerLast-PoolId-">#</a>
</div>
</div>
<div className="px-4">

Returns the last recorded lower tick for a given pool. Takes a `PoolId` `poolId` and returns the
stored `tickLowerLast` value.

</div>
</div>

<a id="LimitOrderHook-getOrderId-struct-PoolKey-int24-bool-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getOrderId(struct PoolKey key, int24 tickLower, bool zeroForOne) → OrderIdLibrary.OrderId</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-getOrderId-struct-PoolKey-int24-bool-">#</a>
</div>
</div>
<div className="px-4">

Retrieves the order id for a given pool position. Takes a `PoolKey` `key`, target `tickLower`, and direction
`zeroForOne` indicating whether it's buying currency0 or currency1. Returns the [`OrderIdLibrary.OrderId`](#OrderIdLibrary-OrderId) associated with this
position, or the default order id if no order exists.

</div>
</div>

<a id="LimitOrderHook-_getTickLower-int24-int24-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_getTickLower(int24 tick, int24 tickSpacing) → int24</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_getTickLower-int24-int24-">#</a>
</div>
</div>
<div className="px-4">

Get the tick lower. Takes a `tick` and `tickSpacing` and returns the nearest valid tick boundary
at or below the input tick, accounting for negative tick handling.

</div>
</div>

<a id="LimitOrderHook-getOrderLiquidity-OrderIdLibrary-OrderId-address-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getOrderLiquidity(OrderIdLibrary.OrderId orderId, address owner) → uint256</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">external</p>
<a className="peer" data-card href="LimitOrderHook-getOrderLiquidity-OrderIdLibrary-OrderId-address-">#</a>
</div>
</div>
<div className="px-4">

Get the liquidity of an order for a given order id and owner. Takes an [`OrderIdLibrary.OrderId`](#OrderIdLibrary-OrderId) `orderId` and `owner` address
and returns the amount of liquidity the owner has contributed to the order.

</div>
</div>

<a id="LimitOrderHook-_getTick-PoolId-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_getTick(PoolId poolId) → int24 tick</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LimitOrderHook-_getTick-PoolId-">#</a>
</div>
</div>
<div className="px-4">

Get the current tick for a given pool. Takes a `PoolId` `poolId` and returns the tick calculated
from the pool's current sqrt price.

</div>
</div>

<a id="LimitOrderHook-getOrderInfo-OrderIdLibrary-OrderId-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getOrderInfo(OrderIdLibrary.OrderId orderId) → bool filled, Currency currency0, Currency currency1, uint256 currency0Total, uint256 currency1Total, uint128 liquidityTotal</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">external</p>
<a className="peer" data-card href="LimitOrderHook-getOrderInfo-OrderIdLibrary-OrderId-">#</a>
</div>
</div>
<div className="px-4">

Get the order info for a given order id. Takes an [`OrderIdLibrary.OrderId`](#OrderIdLibrary-OrderId) `orderId` and returns the order info.

</div>
</div>

<a id="LimitOrderHook-getHookPermissions--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getHookPermissions() → struct Hooks.Permissions permissions</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LimitOrderHook-getHookPermissions--">#</a>
</div>
</div>
<div className="px-4">

Get the hook permissions for this contract. Returns a `Hooks.Permissions` struct configured to enable
`afterInitialize` and `afterSwap` hooks while disabling all other hooks.

</div>
</div>

<a id="LimitOrderHook-Place-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">Place(address indexed owner, OrderIdLibrary.OrderId indexed orderId, struct PoolKey key, int24 tickLower, bool zeroForOne, uint128 liquidity)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">event</p>
<a className="peer" data-card href="LimitOrderHook-Place-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-">#</a>
</div>
</div>

<div className="px-4">

Emitted when an `owner` places a limit order with the given `orderId`, in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order, and `liquidity` the amount of liquidity
added.

</div>
</div>
<a id="LimitOrderHook-Fill-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">Fill(OrderIdLibrary.OrderId indexed orderId, struct PoolKey key, int24 tickLower, bool zeroForOne)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">event</p>
<a className="peer" data-card href="LimitOrderHook-Fill-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-">#</a>
</div>
</div>

<div className="px-4">

Emitted when a limit order with the given `orderId` is filled in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order.

</div>
</div>
<a id="LimitOrderHook-Cancel-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">Cancel(address indexed owner, OrderIdLibrary.OrderId indexed orderId, struct PoolKey key, int24 tickLower, bool zeroForOne, uint128 liquidity)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">event</p>
<a className="peer" data-card href="LimitOrderHook-Cancel-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-">#</a>
</div>
</div>

<div className="px-4">

Emitted when an `owner` cancels a limit order with the given `orderId`, in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order, and `liquidity` the amount of liquidity
removed.

</div>
</div>
<a id="LimitOrderHook-Withdraw-address-OrderIdLibrary-OrderId-uint128-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">Withdraw(address indexed owner, OrderIdLibrary.OrderId indexed orderId, uint128 liquidity)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">event</p>
<a className="peer" data-card href="LimitOrderHook-Withdraw-address-OrderIdLibrary-OrderId-uint128-">#</a>
</div>
</div>

<div className="px-4">

Emitted when an `owner` withdraws their `liquidity` from a limit order with the given `orderId`, in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order.

</div>
</div>

<a id="LimitOrderHook-ZeroLiquidity--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">ZeroLiquidity()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LimitOrderHook-ZeroLiquidity--">#</a>
</div>
</div>
<div className="px-4">

Zero liquidity was attempted to be added or removed.

</div>
</div>

<a id="LimitOrderHook-InRange--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">InRange()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LimitOrderHook-InRange--">#</a>
</div>
</div>
<div className="px-4">

Limit order was placed in range.

</div>
</div>

<a id="LimitOrderHook-CrossedRange--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">CrossedRange()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LimitOrderHook-CrossedRange--">#</a>
</div>
</div>
<div className="px-4">

Limit order placed on the wrong side of the range.

</div>
</div>

<a id="LimitOrderHook-Filled--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">Filled()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LimitOrderHook-Filled--">#</a>
</div>
</div>
<div className="px-4">

Limit order was already filled.

</div>
</div>

<a id="LimitOrderHook-NotFilled--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">NotFilled()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LimitOrderHook-NotFilled--">#</a>
</div>
</div>
<div className="px-4">

Limit order is not filled.

</div>
</div>

<a id="LiquidityPenaltyHook"></a>

<div style={{marginTop: "4em"}} className="w-full flex flex-row items-center justify-between">

## `LiquidityPenaltyHook`

<a target="_blank" style={{marginTop: "1.5em"}} href="https://github.com/OpenZeppelin/uniswap-hooks/blob/v1.1.0/src/general/LiquidityPenaltyHook.sol">
<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-github-icon lucide-github"><path d="M15 22v-4a4.8 4.8 0 0 0-1-3.5c3 0 6-2 6-5.5.08-1.25-.27-2.48-1-3.5.28-1.15.28-2.35 0-3.5 0 0-1 0-3 1.5-2.64-.5-5.36-.5-8 0C6 2 5 2 5 2c-.3 1.15-.3 2.35 0 3.5A5.403 5.403 0 0 0 4 9c0 3.5 3 5.5 6 5.5-.39.49-.68 1.05-.85 1.65-.17.6-.22 1.23-.15 1.85v4"/><path d="M9 18c-4.51 2-5-2-7-2"/></svg>
</a>

</div>

```solidity
import "uniswap-hooks/src/general/LiquidityPenaltyHook.sol";
```

Just-in-Time (JIT) liquidity provisioning resistant hook.

This hook disincentivizes JIT attacks by penalizing LP fee collection during [`BaseHook._afterRemoveLiquidity`](base#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-),
and disabling it during [`BaseHook._afterAddLiquidity`](base#BaseHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-) if liquidity was recently added to the position.
The penalty is donated to the pool's liquidity providers in range at the time of removal.

See [`LiquidityPenaltyHook._calculateLiquidityPenalty`](#LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-) for penalty calculation.

<Callout>
If a long term liquidity provider adds liquidity continuously, a pause of `blockNumberOffset`
before removing will be needed if `feesAccrued` collection is intended, in order to avoid getting
penalized by the JIT protection mechanism.
</Callout>

<Callout type="warn">
Altrough this hook achieves it's objective of protecting long term LP's in most scenarios,
low liquidity pools and long-tail assets may still be vulnerable depending on the configured `blockNumberOffset`.
Larger values of such are recommended in those cases in order to decrease the profitability of the attack.
</Callout>

<Callout type="warn">
In low liquidity pools, this hook may be vulnerable to multi-account strategies: attackers may bypass JIT protection
by using a secondary account to add minimal liquidity at a target tick with no other liquidity, then moving the price there after a JIT attack.
This allows penalty fees to be redirected to the attacker's secondary account. While technically feasible, this attack is rarely profitable in practice,
due to the cost associated with moving the price to the target tick.
</Callout>

<Callout type="warn">
This is experimental software and is provided on an "as is" and "as available" basis. We do
not give any warranties and will not be liable for any losses incurred through any use of this code
base.
</Callout>

_Available since v0.1.1_

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Functions</h3>
<div className="font-mono">
- [constructor(_poolManager, _blockNumberOffset)](#LiquidityPenaltyHook-constructor-contract-IPoolManager-uint48-)
- [_afterAddLiquidity(sender, key, params, , feeDelta, )](#LiquidityPenaltyHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterRemoveLiquidity(sender, key, params, , feeDelta, )](#LiquidityPenaltyHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_getBlockNumber()](#LiquidityPenaltyHook-_getBlockNumber--)
- [_updateLastAddedLiquidityBlock(poolId, positionKey)](#LiquidityPenaltyHook-_updateLastAddedLiquidityBlock-PoolId-bytes32-)
- [_takeFeesToHook(key, positionKey, feeDelta)](#LiquidityPenaltyHook-_takeFeesToHook-struct-PoolKey-bytes32-BalanceDelta-)
- [_settleFeesFromHook(key, positionKey)](#LiquidityPenaltyHook-_settleFeesFromHook-struct-PoolKey-bytes32-)
- [_calculateLiquidityPenalty(feeDelta, lastAddedLiquidityBlock)](#LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-)
- [getLastAddedLiquidityBlock(poolId, positionKey)](#LiquidityPenaltyHook-getLastAddedLiquidityBlock-PoolId-bytes32-)
- [getWithheldFees(poolId, positionKey)](#LiquidityPenaltyHook-getWithheldFees-PoolId-bytes32-)
- [getHookPermissions()](#LiquidityPenaltyHook-getHookPermissions--)
- [MIN_BLOCK_NUMBER_OFFSET()](#LiquidityPenaltyHook-MIN_BLOCK_NUMBER_OFFSET-uint48)
- [blockNumberOffset()](#LiquidityPenaltyHook-blockNumberOffset-uint48)
#### BaseHook [!toc]
- [_validateHookAddress(hook)](#BaseHook-_validateHookAddress-contract-BaseHook-)
- [beforeInitialize(sender, key, sqrtPriceX96)](#BaseHook-beforeInitialize-address-struct-PoolKey-uint160-)
- [_beforeInitialize(, , )](#BaseHook-_beforeInitialize-address-struct-PoolKey-uint160-)
- [afterInitialize(sender, key, sqrtPriceX96, tick)](#BaseHook-afterInitialize-address-struct-PoolKey-uint160-int24-)
- [_afterInitialize(, , , )](#BaseHook-_afterInitialize-address-struct-PoolKey-uint160-int24-)
- [beforeAddLiquidity(sender, key, params, hookData)](#BaseHook-beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeAddLiquidity(, , , )](#BaseHook-_beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [beforeRemoveLiquidity(sender, key, params, hookData)](#BaseHook-beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeRemoveLiquidity(, , , )](#BaseHook-_beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [afterAddLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [afterRemoveLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [beforeSwap(sender, key, params, hookData)](#BaseHook-beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [_beforeSwap(, , , )](#BaseHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [afterSwap(sender, key, params, delta, hookData)](#BaseHook-afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [_afterSwap(, , , , )](#BaseHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [beforeDonate(sender, key, amount0, amount1, hookData)](#BaseHook-beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_beforeDonate(, , , , )](#BaseHook-_beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [afterDonate(sender, key, amount0, amount1, hookData)](#BaseHook-afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_afterDonate(, , , , )](#BaseHook-_afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [poolManager()](#BaseHook-poolManager-contract-IPoolManager)
#### IHooks [!toc]
</div>
</div>

<div className="bg-secondary p-4 rounded-md mb-6">
<h3 style={{ marginTop: "0"}}>Errors</h3>
<div className="font-mono">
- [BlockNumberOffsetTooLow()](#LiquidityPenaltyHook-BlockNumberOffsetTooLow--)
- [NoLiquidityToReceiveDonation()](#LiquidityPenaltyHook-NoLiquidityToReceiveDonation--)
#### BaseHook [!toc]
- [NotSelf()](#BaseHook-NotSelf--)
- [InvalidPool()](#BaseHook-InvalidPool--)
- [HookNotImplemented()](#BaseHook-HookNotImplemented--)
- [NotPoolManager()](#BaseHook-NotPoolManager--)
#### IHooks [!toc]
</div>
</div>

<a id="LiquidityPenaltyHook-constructor-contract-IPoolManager-uint48-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">constructor(contract IPoolManager _poolManager, uint48 _blockNumberOffset)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LiquidityPenaltyHook-constructor-contract-IPoolManager-uint48-">#</a>
</div>
</div>
<div className="px-4">

Sets the `PoolManager` address and the `getBlockNumberOffset`.

</div>
</div>

<a id="LiquidityPenaltyHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_afterAddLiquidity(address sender, struct PoolKey key, struct ModifyLiquidityParams params, BalanceDelta, BalanceDelta feeDelta, bytes) → bytes4, BalanceDelta</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-">#</a>
</div>
</div>
<div className="px-4">

Tracks `lastAddedLiquidityBlock` and withholds `feeDelta` if liquidity was recently added within
the `blockNumberOffset` period.

See [`BaseHook._afterRemoveLiquidity`](base#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-) for claiming the withheld fees back.

</div>
</div>

<a id="LiquidityPenaltyHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_afterRemoveLiquidity(address sender, struct PoolKey key, struct ModifyLiquidityParams params, BalanceDelta, BalanceDelta feeDelta, bytes) → bytes4, BalanceDelta</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-">#</a>
</div>
</div>
<div className="px-4">

Penalizes the collection of any existing LP `feesDelta` and `withheldFees` after liquidity removal if
liquidity was recently added to the position.

<Callout>
The penalty is applied on both `withheldFees` and `feeDelta` equally.
Therefore, regardless of how many times liquidity was added to the position within the `blockNumberOffset` period,
all accrued fees are penalized as if the liquidity was added only once during that period. This ensures that
splitting liquidity additions within the `blockNumberOffset` period does not reduce or increase the penalty.
</Callout>

<Callout type="warn">
The penalty is donated to the pool's liquidity providers in range at the time of liquidity removal,
which may be different from the liquidity providers in range at the time of liquidity addition.
</Callout>

</div>
</div>

<a id="LiquidityPenaltyHook-_getBlockNumber--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_getBlockNumber() → uint48</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_getBlockNumber--">#</a>
</div>
</div>
<div className="px-4">

Returns the current block number.

</div>
</div>

<a id="LiquidityPenaltyHook-_updateLastAddedLiquidityBlock-PoolId-bytes32-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_updateLastAddedLiquidityBlock(PoolId poolId, bytes32 positionKey)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_updateLastAddedLiquidityBlock-PoolId-bytes32-">#</a>
</div>
</div>
<div className="px-4">

Updates the `lastAddedLiquidityBlock` for a liquidity position.

</div>
</div>

<a id="LiquidityPenaltyHook-_takeFeesToHook-struct-PoolKey-bytes32-BalanceDelta-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_takeFeesToHook(struct PoolKey key, bytes32 positionKey, BalanceDelta feeDelta)</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_takeFeesToHook-struct-PoolKey-bytes32-BalanceDelta-">#</a>
</div>
</div>
<div className="px-4">

Takes `feeDelta` from a liquidity position as `withheldFees` into this hook.

</div>
</div>

<a id="LiquidityPenaltyHook-_settleFeesFromHook-struct-PoolKey-bytes32-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_settleFeesFromHook(struct PoolKey key, bytes32 positionKey) → BalanceDelta withheldFees</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_settleFeesFromHook-struct-PoolKey-bytes32-">#</a>
</div>
</div>
<div className="px-4">

Returns `withheldFees` from this hook to the liquidity provider.

</div>
</div>

<a id="LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">_calculateLiquidityPenalty(BalanceDelta feeDelta, uint48 lastAddedLiquidityBlock) → BalanceDelta liquidityPenalty</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">internal</p>
<a className="peer" data-card href="LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-">#</a>
</div>
</div>
<div className="px-4">

Calculates the penalty to be applied to JIT liquidity provisioning.

The penalty is calculated as a linear function of the block number difference between the `lastAddedLiquidityBlock` and the `currentBlockNumber`.

The used formula is:

liquidityPenalty = feeDelta * ( 1 - (currentBlockNumber - lastAddedLiquidityBlock) / blockNumberOffset)

As a result, the penalty is 100% at the same block where liquidity was last added and zero after the `blockNumberOffset` block time window.

<Callout>
Won't overflow if `currentBlockNumber - lastAddedLiquidityBlock < blockNumberOffset` is verified prior to calling this function.
</Callout>

</div>
</div>

<a id="LiquidityPenaltyHook-getLastAddedLiquidityBlock-PoolId-bytes32-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getLastAddedLiquidityBlock(PoolId poolId, bytes32 positionKey) → uint48</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LiquidityPenaltyHook-getLastAddedLiquidityBlock-PoolId-bytes32-">#</a>
</div>
</div>
<div className="px-4">

Tracks the `lastAddedLiquidityBlock` for a liquidity position.

`lastAddedLiquidityBlock` is the block number when liquidity was last added to the position.

</div>
</div>

<a id="LiquidityPenaltyHook-getWithheldFees-PoolId-bytes32-"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getWithheldFees(PoolId poolId, bytes32 positionKey) → BalanceDelta</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LiquidityPenaltyHook-getWithheldFees-PoolId-bytes32-">#</a>
</div>
</div>
<div className="px-4">

Returns the `withheldFees` for a liquidity position.

`withheldFees` are UniswapV4's `feesAccrued` retained by this hook during liquidity addition if liquidity
has been recently added within the `blockNumberOffset` block time window, with the purpose of disabling fee
collection during JIT liquidity provisioning attacks. See [`BaseHook._afterRemoveLiquidity`](base#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-) for claiming the fees back.

</div>
</div>

<a id="LiquidityPenaltyHook-getHookPermissions--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">getHookPermissions() → struct Hooks.Permissions permissions</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LiquidityPenaltyHook-getHookPermissions--">#</a>
</div>
</div>
<div className="px-4">

Set the hooks permissions, specifically `afterAddLiquidity`, `afterAddLiquidityReturnDelta`, `afterRemoveLiquidity` and `afterRemoveLiquidityReturnDelta`.

</div>
</div>

<a id="LiquidityPenaltyHook-MIN_BLOCK_NUMBER_OFFSET-uint48"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">MIN_BLOCK_NUMBER_OFFSET() → uint48</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LiquidityPenaltyHook-MIN_BLOCK_NUMBER_OFFSET-uint48">#</a>
</div>
</div>
<div className="px-4">

The minimum value for the [`LiquidityPenaltyHook.blockNumberOffset`](#LiquidityPenaltyHook-blockNumberOffset-uint48).

</div>
</div>

<a id="LiquidityPenaltyHook-blockNumberOffset-uint48"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">blockNumberOffset() → uint48</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">public</p>
<a className="peer" data-card href="LiquidityPenaltyHook-blockNumberOffset-uint48">#</a>
</div>
</div>
<div className="px-4">

The minimum time window (in blocks) that must pass after adding liquidity before it can be
removed without any penalty. During this period, JIT attacks are deterred through fee withholding
and penalties. Higher values provide stronger JIT protection but may discourage legitimate LPs.

</div>
</div>

<a id="LiquidityPenaltyHook-BlockNumberOffsetTooLow--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">BlockNumberOffsetTooLow()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LiquidityPenaltyHook-BlockNumberOffsetTooLow--">#</a>
</div>
</div>
<div className="px-4">

The hook was attempted to be constructed with a `blockNumberOffset` lower than `MIN_BLOCK_NUMBER_OFFSET`.

</div>
</div>

<a id="LiquidityPenaltyHook-NoLiquidityToReceiveDonation--"></a>

<div className="border rounded-md mb-4">
<div className="bg-secondary flex w-full justify-between px-4">
<p className="font-bold text-sm font-mono">NoLiquidityToReceiveDonation()</p>
<div className="flex flex-row items-center gap-2">
<p className="font-light text-sm">error</p>
<a className="peer" data-card href="LiquidityPenaltyHook-NoLiquidityToReceiveDonation--">#</a>
</div>
</div>
<div className="px-4">

A penalty was attempted to be applied and donated to LP's in range, but there aren't any.

</div>
</div>
