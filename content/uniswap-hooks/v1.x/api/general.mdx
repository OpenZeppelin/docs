---
title: "General"
description: "Smart contract general utilities and implementations"
---

<a id="AntiSandwichHook"></a>

## `AntiSandwichHook` [üìÅ](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v1.1.0/src/general/AntiSandwichHook.sol)

```solidity
import "@openzeppelin/src/general/AntiSandwichHook.sol";
```

This hook implements the sandwich-resistant AMM design introduced
[here](https://www.umbraresearch.xyz/writings/sandwich-resistant-amm). Specifically,
this hook guarantees that no swaps get filled at a price better than the price at
the beginning of the slot window (i.e. one block).

Within a slot window, swaps impact the pool asymmetrically for buys and sells.
When a buy order is executed, the offer on the pool increases in accordance with
the xy=k curve. However, the bid price remains constant, instead increasing the
amount of liquidity on the bid. Subsequent sells eat into this liquidity, while
decreasing the offer price according to xy=k.

In order to use this hook, the inheriting contract must implement the _handleCollectedFees function
to determine how to handle the collected fees from the anti-sandwich mechanism.

NOTE: The Anti-sandwich mechanism only protects swaps in the zeroForOne swap direction.
Swaps in the !zeroForOne direction are not protected by this hook design.

WARNING: Since this hook makes MEV not profitable, there's not as much arbitrage in
the pool, making prices at beginning of the block not necessarily close to market price.

WARNING: In `_beforeSwap`, the hook iterates over all ticks between last tick and current tick.
Developers must be aware that for large price changes in pools with small tick spacing, the `for`
loop will iterate over a large number of ticks, which could lead to `MemoryOOG` error.

WARNING: This is experimental software and is provided on an "as is" and "as available" basis. We do
not give any warranties and will not be liable for any losses incurred through any use of this code
base.

_Available since v1.1.0_

### Functions
- [constructor(_poolManager)](#AntiSandwichHook-constructor-contract-IPoolManager-)
- [_beforeSwap(sender, key, params, hookData)](#AntiSandwichHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [_getBlockNumber()](#AntiSandwichHook-_getBlockNumber--)
- [_getTargetUnspecified(, key, params, )](#AntiSandwichHook-_getTargetUnspecified-address-struct-PoolKey-struct-SwapParams-bytes-)
- [getHookPermissions()](#AntiSandwichHook-getHookPermissions--)

#### BaseDynamicAfterFee
- [_transientTargetUnspecifiedAmount()](#BaseDynamicAfterFee-_transientTargetUnspecifiedAmount--)
- [_transientApplyTarget()](#BaseDynamicAfterFee-_transientApplyTarget--)
- [_setTransientTargetUnspecifiedAmount(value)](#BaseDynamicAfterFee-_setTransientTargetUnspecifiedAmount-uint256-)
- [_setTransientApplyTarget(value)](#BaseDynamicAfterFee-_setTransientApplyTarget-bool-)
- [_afterSwap(sender, key, params, delta, )](#BaseDynamicAfterFee-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [_afterSwapHandler(key, params, delta, targetUnspecifiedAmount, feeAmount)](#BaseDynamicAfterFee-_afterSwapHandler-struct-PoolKey-struct-SwapParams-BalanceDelta-uint256-uint256-)

#### IHookEvents

#### BaseHook
- [validateHookAddress(hook)](#BaseHook-validateHookAddress-contract-BaseHook-)
- [beforeInitialize(sender, key, sqrtPriceX96)](#BaseHook-beforeInitialize-address-struct-PoolKey-uint160-)
- [_beforeInitialize(, , )](#BaseHook-_beforeInitialize-address-struct-PoolKey-uint160-)
- [afterInitialize(sender, key, sqrtPriceX96, tick)](#BaseHook-afterInitialize-address-struct-PoolKey-uint160-int24-)
- [_afterInitialize(, , , )](#BaseHook-_afterInitialize-address-struct-PoolKey-uint160-int24-)
- [beforeAddLiquidity(sender, key, params, hookData)](#BaseHook-beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeAddLiquidity(, , , )](#BaseHook-_beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [beforeRemoveLiquidity(sender, key, params, hookData)](#BaseHook-beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeRemoveLiquidity(, , , )](#BaseHook-_beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [afterAddLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterAddLiquidity(, , , , , )](#BaseHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [afterRemoveLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterRemoveLiquidity(, , , , , )](#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [beforeSwap(sender, key, params, hookData)](#BaseHook-beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [afterSwap(sender, key, params, delta, hookData)](#BaseHook-afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [beforeDonate(sender, key, amount0, amount1, hookData)](#BaseHook-beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_beforeDonate(, , , , )](#BaseHook-_beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [afterDonate(sender, key, amount0, amount1, hookData)](#BaseHook-afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_afterDonate(, , , , )](#BaseHook-_afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [poolManager()](#BaseHook-poolManager-contract-IPoolManager)

#### IHooks

### Events

#### BaseDynamicAfterFee

#### IHookEvents
- [HookSwap(poolId, sender, amount0, amount1, hookLPfeeAmount0, hookLPfeeAmount1)](#IHookEvents-HookSwap-bytes32-address-int128-int128-uint128-uint128-)
- [HookFee(poolId, sender, feeAmount0, feeAmount1)](#IHookEvents-HookFee-bytes32-address-uint128-uint128-)
- [HookModifyLiquidity(poolId, sender, amount0, amount1)](#IHookEvents-HookModifyLiquidity-bytes32-address-int128-int128-)
- [HookBonus(poolId, amount0, amount1)](#IHookEvents-HookBonus-bytes32-uint128-uint128-)

#### BaseHook

#### IHooks

### Errors

#### BaseDynamicAfterFee

#### IHookEvents

#### BaseHook
- [NotSelf()](#BaseHook-NotSelf--)
- [InvalidPool()](#BaseHook-InvalidPool--)
- [HookNotImplemented()](#BaseHook-HookNotImplemented--)
- [NotPoolManager()](#BaseHook-NotPoolManager--)

#### IHooks

<a id="AntiSandwichHook-constructor-contract-IPoolManager-"></a>

### `constructor(contract IPoolManager _poolManager)`
*internal*

<a id="AntiSandwichHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-"></a>

### `_beforeSwap(address sender, struct PoolKey key, struct SwapParams params, bytes hookData) ‚Üí bytes4, BeforeSwapDelta, uint24`
*internal*

Handles the before swap hook.

For the first swap in a block, it saves the current pool state as a checkpoint.

For subsequent swaps in the same block, it calculates a target output based on the beginning-of-block state,
and sets the inherited `_targetOutput` and `_applyTargetOutput` variables to enforce price limits in [`BaseHook._afterSwap`](base#BaseHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-).

<a id="AntiSandwichHook-_getBlockNumber--"></a>

### `_getBlockNumber() ‚Üí uint48`
*internal*

Returns the current block number.

<a id="AntiSandwichHook-_getTargetUnspecified-address-struct-PoolKey-struct-SwapParams-bytes-"></a>

### `_getTargetUnspecified(address, struct PoolKey key, struct SwapParams params, bytes) ‚Üí uint256 targetUnspecifiedAmount, bool applyTarget`
*internal*

Calculates the unspecified amount based on the pool state at the beginning of the block.
This prevents sandwich attacks by ensuring trades can't get better prices than what was available
at the start of the block. Note that the calculated unspecified amount could either be input or output, depending
if it's an exactInput or outputOutput swap. In cases of zeroForOne == true, the target unspecified amount is not
applicable, and the max uint256 value is returned as a flag only.

The anti-sandwich mechanism works such as:

- For currency0 to currency1 swaps (zeroForOne = true): The pool behaves normally with xy=k curve.
- For currency1 to currency0 swaps (zeroForOne = false): The price is fixed at the beginning-of-block
  price, which prevents attackers from manipulating the price within a block.

<a id="AntiSandwichHook-getHookPermissions--"></a>

### `getHookPermissions() ‚Üí struct Hooks.Permissions permissions`
*public*

Set the hook permissions, specifically `beforeSwap`, `afterSwap`, and `afterSwapReturnDelta`.

<a id="OrderIdLibrary"></a>

## `OrderIdLibrary` [üìÅ](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v1.1.0/src/general/LimitOrderHook.sol)

```solidity
import "@openzeppelin/src/general/LimitOrderHook.sol";
```

The order id library.

### Functions
- [equals(a, b)](#OrderIdLibrary-equals-OrderIdLibrary-OrderId-OrderIdLibrary-OrderId-)
- [unsafeIncrement(a)](#OrderIdLibrary-unsafeIncrement-OrderIdLibrary-OrderId-)

<a id="OrderIdLibrary-equals-OrderIdLibrary-OrderId-OrderIdLibrary-OrderId-"></a>

### `equals(OrderIdLibrary.OrderId a, OrderIdLibrary.OrderId b) ‚Üí bool`
*internal*

Compare two order ids for equality. Takes two `OrderId` values `a` and `b` and
returns whether their underlying values are equal.

<a id="OrderIdLibrary-unsafeIncrement-OrderIdLibrary-OrderId-"></a>

### `unsafeIncrement(OrderIdLibrary.OrderId a) ‚Üí OrderIdLibrary.OrderId`
*internal*

Increment the order id `a`. Might overflow.

<a id="LimitOrderHook"></a>

## `LimitOrderHook` [üìÅ](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v1.1.0/src/general/LimitOrderHook.sol)

```solidity
import "@openzeppelin/src/general/LimitOrderHook.sol";
```

Limit Order Mechanism hook.

Allows users to place limit orders at specific ticks outside of the current price range,
which will be filled if the pool's price crosses the order's tick.

Note that given the way UniswapV4 pools works, when liquidity is added out of the current range,
a single currency will be provided, instead of both currencies as in in-range liquidity additions.

Orders can be cancelled at any time until they are filled and their liquidity is removed from the pool.
Once completely filled, the resulting liquidity can be withdrawn from the pool.

IMPORTANT: When cancelling or adding more liquidity into an existing order, it's possible that fees
have been accrued. In those cases, the accrued fees are added to the order info, benefitting the remaining
limit order placers.

WARNING: This is experimental software and is provided on an "as is" and "as available" basis. We do
not give any warranties and will not be liable for any losses incurred through any use of this code
base.

_Available since v1.1.0_

### Functions
- [constructor(_poolManager)](#LimitOrderHook-constructor-contract-IPoolManager-)
- [_afterInitialize(, key, , tick)](#LimitOrderHook-_afterInitialize-address-struct-PoolKey-uint160-int24-)
- [_afterSwap(, key, params, , )](#LimitOrderHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [placeOrder(key, tick, zeroForOne, liquidity)](#LimitOrderHook-placeOrder-struct-PoolKey-int24-bool-uint128-)
- [cancelOrder(key, tickLower, zeroForOne, to)](#LimitOrderHook-cancelOrder-struct-PoolKey-int24-bool-address-)
- [withdraw(orderId, to)](#LimitOrderHook-withdraw-OrderIdLibrary-OrderId-address-)
- [unlockCallback(rawData)](#LimitOrderHook-unlockCallback-bytes-)
- [_handlePlaceCallback(placeData)](#LimitOrderHook-_handlePlaceCallback-struct-LimitOrderHook-PlaceCallbackData-)
- [_handleCancelCallback(cancelData)](#LimitOrderHook-_handleCancelCallback-struct-LimitOrderHook-CancelCallbackData-)
- [_handleWithdrawCallback(withdrawData)](#LimitOrderHook-_handleWithdrawCallback-struct-LimitOrderHook-WithdrawCallbackData-)
- [_fillOrder(key, tickLower, zeroForOne)](#LimitOrderHook-_fillOrder-struct-PoolKey-int24-bool-)
- [_getCrossedTicks(poolId, tickSpacing)](#LimitOrderHook-_getCrossedTicks-PoolId-int24-)
- [getTickLowerLast(poolId)](#LimitOrderHook-getTickLowerLast-PoolId-)
- [getOrderId(key, tickLower, zeroForOne)](#LimitOrderHook-getOrderId-struct-PoolKey-int24-bool-)
- [getOrderLiquidity(orderId, owner)](#LimitOrderHook-getOrderLiquidity-OrderIdLibrary-OrderId-address-)
- [getHookPermissions()](#LimitOrderHook-getHookPermissions--)
- [orderInfos()](#LimitOrderHook-orderInfos-mapping-OrderIdLibrary-OrderId----struct-LimitOrderHook-OrderInfo-)

#### IUnlockCallback

#### BaseHook
- [validateHookAddress(hook)](#BaseHook-validateHookAddress-contract-BaseHook-)
- [beforeInitialize(sender, key, sqrtPriceX96)](#BaseHook-beforeInitialize-address-struct-PoolKey-uint160-)
- [_beforeInitialize(, , )](#BaseHook-_beforeInitialize-address-struct-PoolKey-uint160-)
- [afterInitialize(sender, key, sqrtPriceX96, tick)](#BaseHook-afterInitialize-address-struct-PoolKey-uint160-int24-)
- [beforeAddLiquidity(sender, key, params, hookData)](#BaseHook-beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeAddLiquidity(, , , )](#BaseHook-_beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [beforeRemoveLiquidity(sender, key, params, hookData)](#BaseHook-beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeRemoveLiquidity(, , , )](#BaseHook-_beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [afterAddLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterAddLiquidity(, , , , , )](#BaseHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [afterRemoveLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterRemoveLiquidity(, , , , , )](#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [beforeSwap(sender, key, params, hookData)](#BaseHook-beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [_beforeSwap(, , , )](#BaseHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [afterSwap(sender, key, params, delta, hookData)](#BaseHook-afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [beforeDonate(sender, key, amount0, amount1, hookData)](#BaseHook-beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_beforeDonate(, , , , )](#BaseHook-_beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [afterDonate(sender, key, amount0, amount1, hookData)](#BaseHook-afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_afterDonate(, , , , )](#BaseHook-_afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [poolManager()](#BaseHook-poolManager-contract-IPoolManager)

#### IHooks

### Events
- [Place(owner, orderId, key, tickLower, zeroForOne, liquidity)](#LimitOrderHook-Place-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-)
- [Fill(orderId, key, tickLower, zeroForOne)](#LimitOrderHook-Fill-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-)
- [Cancel(owner, orderId, key, tickLower, zeroForOne, liquidity)](#LimitOrderHook-Cancel-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-)
- [Withdraw(owner, orderId, liquidity)](#LimitOrderHook-Withdraw-address-OrderIdLibrary-OrderId-uint128-)

#### IUnlockCallback

#### BaseHook

#### IHooks

### Errors
- [ZeroLiquidity()](#LimitOrderHook-ZeroLiquidity--)
- [InRange()](#LimitOrderHook-InRange--)
- [CrossedRange()](#LimitOrderHook-CrossedRange--)
- [Filled()](#LimitOrderHook-Filled--)
- [NotFilled()](#LimitOrderHook-NotFilled--)

#### IUnlockCallback

#### BaseHook
- [NotSelf()](#BaseHook-NotSelf--)
- [InvalidPool()](#BaseHook-InvalidPool--)
- [HookNotImplemented()](#BaseHook-HookNotImplemented--)
- [NotPoolManager()](#BaseHook-NotPoolManager--)

#### IHooks

<a id="LimitOrderHook-constructor-contract-IPoolManager-"></a>

### `constructor(contract IPoolManager _poolManager)`
*public*

Set the `PoolManager` address.

<a id="LimitOrderHook-_afterInitialize-address-struct-PoolKey-uint160-int24-"></a>

### `_afterInitialize(address, struct PoolKey key, uint160, int24 tick) ‚Üí bytes4`
*internal*

Hooks into the `afterInitialize` hook to set the last tick lower for the pool.

<a id="LimitOrderHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-"></a>

### `_afterSwap(address, struct PoolKey key, struct SwapParams params, BalanceDelta, bytes) ‚Üí bytes4, int128`
*internal*

Hooks into the `afterSwap` hook to get the ticks crossed by the swap and fill the orders that are crossed, filling them.

<a id="LimitOrderHook-placeOrder-struct-PoolKey-int24-bool-uint128-"></a>

### `placeOrder(struct PoolKey key, int24 tick, bool zeroForOne, uint128 liquidity)`
*external*

Places a limit order by adding liquidity out of range at a specific tick. The order will be filled when the
pool price crosses the specified `tick`. Takes a `PoolKey` `key`, target `tick`, direction `zeroForOne` indicating
whether to buy currency0 or currency1, and amount of `liquidity` to place. The interaction with the `poolManager` is done
via the `unlock` function, which will trigger the `[`BaseCustomAccounting.unlockCallback`](base#BaseCustomAccounting-unlockCallback-bytes-)` function.

<a id="LimitOrderHook-cancelOrder-struct-PoolKey-int24-bool-address-"></a>

### `cancelOrder(struct PoolKey key, int24 tickLower, bool zeroForOne, address to)`
*external*

Cancels a limit order by removing liquidity from the pool. Takes a `PoolKey` `key`, `tickLower` of the order,
direction `zeroForOne` indicating whether it was buying currency0 or currency1, and recipient address `to` for the
removed liquidity. Note that partial cancellation is not supported - the entire liquidity added by the msg.sender will be removed.
Note also that cancelling an order will cancel the order placed by the msg.sender, not orders placed by other users in the same tick range.
The interaction with the `poolManager` is done via the `unlock` function, which will trigger the `[`BaseCustomAccounting.unlockCallback`](base#BaseCustomAccounting-unlockCallback-bytes-)` function.

<a id="LimitOrderHook-withdraw-OrderIdLibrary-OrderId-address-"></a>

### `withdraw(OrderIdLibrary.OrderId orderId, address to) ‚Üí uint256 amount0, uint256 amount1`
*external*

Withdraws liquidity from a filled order, sending it to address `to`. Takes an `OrderId` `orderId` of the filled
order to withdraw from. Returns the withdrawn amounts as `(amount0, amount1)`. Can only be called after the order is
filled - use `cancelOrder` to remove liquidity from unfilled orders. The interaction with the `poolManager` is done via the
`unlock` function, which will trigger the `[`BaseCustomAccounting.unlockCallback`](base#BaseCustomAccounting-unlockCallback-bytes-)` function.

<a id="LimitOrderHook-unlockCallback-bytes-"></a>

### `unlockCallback(bytes rawData) ‚Üí bytes returnData`
*external*

Handles callbacks from the `PoolManager` for order operations. Takes encoded `rawData` containing the callback type
and operation-specific data. Returns encoded data containing fees accrued for cancel operations, or empty bytes
otherwise. Only callable by the PoolManager.

<a id="LimitOrderHook-_handlePlaceCallback-struct-LimitOrderHook-PlaceCallbackData-"></a>

### `_handlePlaceCallback(struct LimitOrderHook.PlaceCallbackData placeData) ‚Üí uint256 amount0Fee, uint256 amount1Fee`
*internal*

Internal handler for place order callbacks. Takes `placeData` containing the order details and adds the
specified liquidity to the pool out of range. Reverts if the order would be placed in range or on the wrong
side of the range.

<a id="LimitOrderHook-_handleCancelCallback-struct-LimitOrderHook-CancelCallbackData-"></a>

### `_handleCancelCallback(struct LimitOrderHook.CancelCallbackData cancelData) ‚Üí uint256 amount0Fee, uint256 amount1Fee`
*internal*

Internal handler for cancel order callbacks. Takes `cancelData` containing the cancellation details and
removes liquidity from the pool. Returns accrued fees `(amount0Fee, amount1Fee)` which are allocated to remaining
limit order placers, or to the cancelling user if they're removing all liquidity.

<a id="LimitOrderHook-_handleWithdrawCallback-struct-LimitOrderHook-WithdrawCallbackData-"></a>

### `_handleWithdrawCallback(struct LimitOrderHook.WithdrawCallbackData withdrawData)`
*internal*

Internal handler for withdraw callbacks. Takes `withdrawData` containing withdrawal amounts and recipient,
burns the specified currency amounts from the hook, and transfers them to the recipient address.

<a id="LimitOrderHook-_fillOrder-struct-PoolKey-int24-bool-"></a>

### `_fillOrder(struct PoolKey key, int24 tickLower, bool zeroForOne)`
*internal*

Internal handler for filling limit orders when price crosses a tick. Takes a `PoolKey` `key`, target `tickLower`,
and direction `zeroForOne`. Removes liquidity from filled orders, mints the received currencies to the hook, and
updates order state to track filled amounts.

<a id="LimitOrderHook-_getCrossedTicks-PoolId-int24-"></a>

### `_getCrossedTicks(PoolId poolId, int24 tickSpacing) ‚Üí int24 tickLower, int24 lower, int24 upper`
*internal*

Internal helper that calculates the range of ticks crossed during a price change. Takes a `PoolId` `poolId`
and `tickSpacing`, returns the current `tickLower` and the range of ticks crossed (`lower`, `upper`) that need
to be checked for limit orders.

<a id="LimitOrderHook-getTickLowerLast-PoolId-"></a>

### `getTickLowerLast(PoolId poolId) ‚Üí int24`
*public*

Returns the last recorded lower tick for a given pool. Takes a `PoolId` `poolId` and returns the
stored `tickLowerLast` value.

<a id="LimitOrderHook-getOrderId-struct-PoolKey-int24-bool-"></a>

### `getOrderId(struct PoolKey key, int24 tickLower, bool zeroForOne) ‚Üí OrderIdLibrary.OrderId`
*public*

Retrieves the order id for a given pool position. Takes a `PoolKey` `key`, target `tickLower`, and direction
`zeroForOne` indicating whether it's buying currency0 or currency1. Returns the [`OrderIdLibrary.OrderId`](#OrderIdLibrary-OrderId) associated with this
position, or the default order id if no order exists.

<a id="LimitOrderHook-getOrderLiquidity-OrderIdLibrary-OrderId-address-"></a>

### `getOrderLiquidity(OrderIdLibrary.OrderId orderId, address owner) ‚Üí uint256`
*external*

Get the liquidity of an order for a given order id and owner. Takes an [`OrderIdLibrary.OrderId`](#OrderIdLibrary-OrderId) `orderId` and `owner` address
and returns the amount of liquidity the owner has contributed to the order.

<a id="LimitOrderHook-getHookPermissions--"></a>

### `getHookPermissions() ‚Üí struct Hooks.Permissions permissions`
*public*

Get the hook permissions for this contract. Returns a `Hooks.Permissions` struct configured to enable
`afterInitialize` and `afterSwap` hooks while disabling all other hooks.

<a id="LimitOrderHook-orderInfos-mapping-OrderIdLibrary-OrderId----struct-LimitOrderHook-OrderInfo-"></a>

### `orderInfos() ‚Üí mapping(OrderIdLibrary.OrderId &#x3D;&gt; struct LimitOrderHook.OrderInfo)`
*public*

Tracks the order info for each order id.

<a id="LimitOrderHook-Place-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-"></a>

### `Place(address indexed owner, OrderIdLibrary.OrderId indexed orderId, struct PoolKey key, int24 tickLower, bool zeroForOne, uint128 liquidity)`
*event*

Emitted when an `owner` places a limit order with the given `orderId`, in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order, and `liquidity` the amount of liquidity
added.

<a id="LimitOrderHook-Fill-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-"></a>

### `Fill(OrderIdLibrary.OrderId indexed orderId, struct PoolKey key, int24 tickLower, bool zeroForOne)`
*event*

Emitted when a limit order with the given `orderId` is filled in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order.

<a id="LimitOrderHook-Cancel-address-OrderIdLibrary-OrderId-struct-PoolKey-int24-bool-uint128-"></a>

### `Cancel(address indexed owner, OrderIdLibrary.OrderId indexed orderId, struct PoolKey key, int24 tickLower, bool zeroForOne, uint128 liquidity)`
*event*

Emitted when an `owner` cancels a limit order with the given `orderId`, in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order, and `liquidity` the amount of liquidity
removed.

<a id="LimitOrderHook-Withdraw-address-OrderIdLibrary-OrderId-uint128-"></a>

### `Withdraw(address indexed owner, OrderIdLibrary.OrderId indexed orderId, uint128 liquidity)`
*event*

Emitted when an `owner` withdraws their `liquidity` from a limit order with the given `orderId`, in the pool identified by `key`,
at the given `tickLower`, `zeroForOne` indicating the direction of the order.

<a id="LimitOrderHook-ZeroLiquidity--"></a>

### `ZeroLiquidity()`
*error*

Zero liquidity was attempted to be added or removed.

<a id="LimitOrderHook-InRange--"></a>

### `InRange()`
*error*

Limit order was placed in range.

<a id="LimitOrderHook-CrossedRange--"></a>

### `CrossedRange()`
*error*

Limit order placed on the wrong side of the range.

<a id="LimitOrderHook-Filled--"></a>

### `Filled()`
*error*

Limit order was already filled.

<a id="LimitOrderHook-NotFilled--"></a>

### `NotFilled()`
*error*

Limit order is not filled.

<a id="LiquidityPenaltyHook"></a>

## `LiquidityPenaltyHook` [üìÅ](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/v1.1.0/src/general/LiquidityPenaltyHook.sol)

```solidity
import "@openzeppelin/src/general/LiquidityPenaltyHook.sol";
```

Just-in-Time (JIT) liquidity provisioning resistant hook.

This hook disincentivizes JIT attacks by penalizing LP fee collection during [`BaseHook._afterRemoveLiquidity`](base#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-),
and disabling it during [`BaseHook._afterAddLiquidity`](base#BaseHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-) if liquidity was recently added to the position.
The penalty is donated to the pool's liquidity providers in range at the time of removal.

See [`LiquidityPenaltyHook._calculateLiquidityPenalty`](#LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-) for penalty calculation.

NOTE: If a long term liquidity provider adds liquidity continuously, a pause of `blockNumberOffset`
before removing will be needed if `feesAccrued` collection is intended, in order to avoid getting
penalized by the JIT protection mechanism.

WARNING: Altrough this hook achieves it's objective of protecting long term LP's in most scenarios,
low liquidity pools and long-tail assets may still be vulnerable depending on the configured `blockNumberOffset`.
Larger values of such are recommended in those cases in order to decrease the profitability of the attack.

WARNING: In low liquidity pools, this hook may be vulnerable to multi-account strategies: attackers may bypass JIT protection
by using a secondary account to add minimal liquidity at a target tick with no other liquidity, then moving the price there after a JIT attack.
This allows penalty fees to be redirected to the attacker's secondary account. While technically feasible, this attack is rarely profitable in practice,
due to the cost associated with moving the price to the target tick.

WARNING: This is experimental software and is provided on an "as is" and "as available" basis. We do
not give any warranties and will not be liable for any losses incurred through any use of this code
base.

_Available since v0.1.1_

### Functions
- [constructor(poolManager_, blockNumberOffset_)](#LiquidityPenaltyHook-constructor-contract-IPoolManager-uint48-)
- [_afterAddLiquidity(sender, key, params, , feeDelta, )](#LiquidityPenaltyHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_afterRemoveLiquidity(sender, key, params, , feeDelta, )](#LiquidityPenaltyHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [_getBlockNumber()](#LiquidityPenaltyHook-_getBlockNumber--)
- [_updateLastAddedLiquidityBlock(poolId, positionKey)](#LiquidityPenaltyHook-_updateLastAddedLiquidityBlock-PoolId-bytes32-)
- [_takeFeesToHook(key, positionKey, feeDelta)](#LiquidityPenaltyHook-_takeFeesToHook-struct-PoolKey-bytes32-BalanceDelta-)
- [_settleFeesFromHook(key, positionKey)](#LiquidityPenaltyHook-_settleFeesFromHook-struct-PoolKey-bytes32-)
- [_calculateLiquidityPenalty(feeDelta, lastAddedLiquidityBlock)](#LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-)
- [getBlockNumberOffset()](#LiquidityPenaltyHook-getBlockNumberOffset--)
- [getLastAddedLiquidityBlock(poolId, positionKey)](#LiquidityPenaltyHook-getLastAddedLiquidityBlock-PoolId-bytes32-)
- [getWithheldFees(poolId, positionKey)](#LiquidityPenaltyHook-getWithheldFees-PoolId-bytes32-)
- [getHookPermissions()](#LiquidityPenaltyHook-getHookPermissions--)
- [MIN_BLOCK_NUMBER_OFFSET()](#LiquidityPenaltyHook-MIN_BLOCK_NUMBER_OFFSET-uint48)

#### BaseHook
- [validateHookAddress(hook)](#BaseHook-validateHookAddress-contract-BaseHook-)
- [beforeInitialize(sender, key, sqrtPriceX96)](#BaseHook-beforeInitialize-address-struct-PoolKey-uint160-)
- [_beforeInitialize(, , )](#BaseHook-_beforeInitialize-address-struct-PoolKey-uint160-)
- [afterInitialize(sender, key, sqrtPriceX96, tick)](#BaseHook-afterInitialize-address-struct-PoolKey-uint160-int24-)
- [_afterInitialize(, , , )](#BaseHook-_afterInitialize-address-struct-PoolKey-uint160-int24-)
- [beforeAddLiquidity(sender, key, params, hookData)](#BaseHook-beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeAddLiquidity(, , , )](#BaseHook-_beforeAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [beforeRemoveLiquidity(sender, key, params, hookData)](#BaseHook-beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [_beforeRemoveLiquidity(, , , )](#BaseHook-_beforeRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-bytes-)
- [afterAddLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [afterRemoveLiquidity(sender, key, params, delta0, delta1, hookData)](#BaseHook-afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-)
- [beforeSwap(sender, key, params, hookData)](#BaseHook-beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [_beforeSwap(, , , )](#BaseHook-_beforeSwap-address-struct-PoolKey-struct-SwapParams-bytes-)
- [afterSwap(sender, key, params, delta, hookData)](#BaseHook-afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [_afterSwap(, , , , )](#BaseHook-_afterSwap-address-struct-PoolKey-struct-SwapParams-BalanceDelta-bytes-)
- [beforeDonate(sender, key, amount0, amount1, hookData)](#BaseHook-beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_beforeDonate(, , , , )](#BaseHook-_beforeDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [afterDonate(sender, key, amount0, amount1, hookData)](#BaseHook-afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [_afterDonate(, , , , )](#BaseHook-_afterDonate-address-struct-PoolKey-uint256-uint256-bytes-)
- [poolManager()](#BaseHook-poolManager-contract-IPoolManager)

#### IHooks

### Errors
- [BlockNumberOffsetTooLow()](#LiquidityPenaltyHook-BlockNumberOffsetTooLow--)
- [NoLiquidityToReceiveDonation()](#LiquidityPenaltyHook-NoLiquidityToReceiveDonation--)

#### BaseHook
- [NotSelf()](#BaseHook-NotSelf--)
- [InvalidPool()](#BaseHook-InvalidPool--)
- [HookNotImplemented()](#BaseHook-HookNotImplemented--)
- [NotPoolManager()](#BaseHook-NotPoolManager--)

#### IHooks

<a id="LiquidityPenaltyHook-constructor-contract-IPoolManager-uint48-"></a>

### `constructor(contract IPoolManager poolManager_, uint48 blockNumberOffset_)`
*public*

Sets the `PoolManager` address and the [`LiquidityPenaltyHook.getBlockNumberOffset`](#LiquidityPenaltyHook-getBlockNumberOffset--).

<a id="LiquidityPenaltyHook-_afterAddLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-"></a>

### `_afterAddLiquidity(address sender, struct PoolKey key, struct ModifyLiquidityParams params, BalanceDelta, BalanceDelta feeDelta, bytes) ‚Üí bytes4, BalanceDelta`
*internal*

Tracks `lastAddedLiquidityBlock` and withholds `feeDelta` if liquidity was recently added within
the `blockNumberOffset` period.

See [`BaseHook._afterRemoveLiquidity`](base#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-) for claiming the withheld fees back.

<a id="LiquidityPenaltyHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-"></a>

### `_afterRemoveLiquidity(address sender, struct PoolKey key, struct ModifyLiquidityParams params, BalanceDelta, BalanceDelta feeDelta, bytes) ‚Üí bytes4, BalanceDelta`
*internal*

Penalizes the collection of any existing LP `feesDelta` and `withheldFees` after liquidity removal if
liquidity was recently added to the position.

NOTE: The penalty is applied on both `withheldFees` and `feeDelta` equally.
Therefore, regardless of how many times liquidity was added to the position within the `blockNumberOffset` period,
all accrued fees are penalized as if the liquidity was added only once during that period. This ensures that
splitting liquidity additions within the `blockNumberOffset` period does not reduce or increase the penalty.

IMPORTANT: The penalty is donated to the pool's liquidity providers in range at the time of liquidity removal,
which may be different from the liquidity providers in range at the time of liquidity addition.

<a id="LiquidityPenaltyHook-_getBlockNumber--"></a>

### `_getBlockNumber() ‚Üí uint48`
*internal*

Returns the current block number.

<a id="LiquidityPenaltyHook-_updateLastAddedLiquidityBlock-PoolId-bytes32-"></a>

### `_updateLastAddedLiquidityBlock(PoolId poolId, bytes32 positionKey)`
*internal*

Updates the `lastAddedLiquidityBlock` for a liquidity position.

<a id="LiquidityPenaltyHook-_takeFeesToHook-struct-PoolKey-bytes32-BalanceDelta-"></a>

### `_takeFeesToHook(struct PoolKey key, bytes32 positionKey, BalanceDelta feeDelta)`
*internal*

Takes `feeDelta` from a liquidity position as `withheldFees` into this hook.

<a id="LiquidityPenaltyHook-_settleFeesFromHook-struct-PoolKey-bytes32-"></a>

### `_settleFeesFromHook(struct PoolKey key, bytes32 positionKey) ‚Üí BalanceDelta withheldFees`
*internal*

Returns `withheldFees` from this hook to the liquidity provider.

<a id="LiquidityPenaltyHook-_calculateLiquidityPenalty-BalanceDelta-uint48-"></a>

### `_calculateLiquidityPenalty(BalanceDelta feeDelta, uint48 lastAddedLiquidityBlock) ‚Üí BalanceDelta liquidityPenalty`
*internal*

Calculates the penalty to be applied to JIT liquidity provisioning.

The penalty is calculated as a linear function of the block number difference between the `lastAddedLiquidityBlock` and the `currentBlockNumber`.

The used formula is:

liquidityPenalty = feeDelta * ( 1 - (currentBlockNumber - lastAddedLiquidityBlock) / blockNumberOffset)

As a result, the penalty is 100% at the same block where liquidity was last added and zero after the `blockNumberOffset` block time window.

NOTE: Won't overflow if `currentBlockNumber - lastAddedLiquidityBlock < blockNumberOffset` is verified prior to calling this function.

<a id="LiquidityPenaltyHook-getBlockNumberOffset--"></a>

### `getBlockNumberOffset() ‚Üí uint48`
*public*

The minimum time window (in blocks) that must pass after adding liquidity before it can be
removed without any penalty. During this period, JIT attacks are deterred through fee withholding
and penalties. Higher values provide stronger JIT protection but may discourage legitimate LPs.

<a id="LiquidityPenaltyHook-getLastAddedLiquidityBlock-PoolId-bytes32-"></a>

### `getLastAddedLiquidityBlock(PoolId poolId, bytes32 positionKey) ‚Üí uint48`
*public*

Tracks the `lastAddedLiquidityBlock` for a liquidity position.

`lastAddedLiquidityBlock` is the block number when liquidity was last added to the position.

<a id="LiquidityPenaltyHook-getWithheldFees-PoolId-bytes32-"></a>

### `getWithheldFees(PoolId poolId, bytes32 positionKey) ‚Üí BalanceDelta`
*public*

Returns the `withheldFees` for a liquidity position.

`withheldFees` are UniswapV4's `feesAccrued` retained by this hook during liquidity addition if liquidity
has been recently added within the `blockNumberOffset` block time window, with the purpose of disabling fee
collection during JIT liquidity provisioning attacks. See [`BaseHook._afterRemoveLiquidity`](base#BaseHook-_afterRemoveLiquidity-address-struct-PoolKey-struct-ModifyLiquidityParams-BalanceDelta-BalanceDelta-bytes-) for claiming the fees back.

<a id="LiquidityPenaltyHook-getHookPermissions--"></a>

### `getHookPermissions() ‚Üí struct Hooks.Permissions permissions`
*public*

Set the hooks permissions, specifically `afterAddLiquidity`, `afterAddLiquidityReturnDelta`, `afterRemoveLiquidity` and `afterRemoveLiquidityReturnDelta`.

<a id="LiquidityPenaltyHook-MIN_BLOCK_NUMBER_OFFSET-uint48"></a>

### `MIN_BLOCK_NUMBER_OFFSET() ‚Üí uint48`
*public*

The minimum block number offset.

<a id="LiquidityPenaltyHook-BlockNumberOffsetTooLow--"></a>

### `BlockNumberOffsetTooLow()`
*error*

The hook was attempted to be constructed with a `blockNumberOffset` lower than `MIN_BLOCK_NUMBER_OFFSET`.

<a id="LiquidityPenaltyHook-NoLiquidityToReceiveDonation--"></a>

### `NoLiquidityToReceiveDonation()`
*error*

A penalty was attempted to be applied and donated to LP's in range, but there aren't any.

